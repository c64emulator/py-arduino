<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
		<title>jQuery UI Example Page</title>
		<link type="text/css" href="/static/css/ui-lightness/jquery-ui-1.8.13.custom.css" rel="stylesheet" />	
		<script type="text/javascript" src="/static/js/jquery-1.5.1.min.js"></script>
		<script type="text/javascript" src="/static/js/jquery-ui-1.8.13.custom.min.js"></script>
		<style type="text/css">
			body{ font: 62.5% sans-serif; margin: 20px; color: #777; }
			.pin_status_text { color: #333; }
			div.pwm_slide { padding-top: 5px; }
		</style>	
		<script type="text/javascript">
			
			//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
			// Generic functions
			//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
			
			function get_pin(text) {
				groups = /^pin(\d+)_/(text);
				if(groups == null)
					alert("groups == null / text='" + text + "'");
				return parseInt(groups[1]);
			}
			
			function pin_status_text(pin, text) {
				$("#pin" + pin + "_status_text").html(text);
			}
			
			function pin_mode_disable(pin) {
				// $(this).attr('id') -> ID of component that generated the event :-)
				pin_status_text(pin, 'Pin disabled');
				$('.pin' + pin + '_for_read').hide();
				$('.pin' + pin + '_for_write').hide();
				// TODO: reset selected
			}
			
			function pin_mode_input(pin) {
				pin_status_text(pin, 'Mode: INPUT');
				$('.pin' + pin + '_for_read').show();
				$('.pin' + pin + '_for_write').hide();
				// TODO: reset selected
			}

			function pin_mode_output(pin) {
				pin_status_text(pin, 'Mode: OUTPUT');
				$('.pin' + pin + '_for_read').hide();
				$('.pin' + pin + '_for_write').show();
				// TODO: reset selected
			}
			
			function pin_digital_write_low(pin) {
				pin_status_text(pin, 'digitalWrite(): LOW');
				if($('#pin' + pin + '_pwm_slider').size()) {
					$('#pin' + pin + '_pwm_slider').slider("value", 0);
				}
			}

			function pin_digital_write_high(pin) {
				pin_status_text(pin, 'digitalWrite(): HIGH');
				if($('#pin' + pin + '_pwm_slider').size()) {
					$('#pin' + pin + '_pwm_slider').slider("value", 255);
				}
			}
		
			$(function(){
				
				//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
				// ping
				//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
				
				$("#ping_button").button();
				$("#ping_button").click(function() {
					$("#ping_result").html('waiting for response...');
					$.ajax({
					  url: '/ping',
					  dataType: 'json',
					  success: function(data, textStatus, jqXHR) {
						  if(data.ok) {
							  $("#ping_result").html('PING OK');
						  } else {
							  $("#ping_result").html('no response');
						  }
					  },
					  error: function(jqXHR, textStatus, errorThrown) {
						alert('AJAX ERROR');
					  }
					});
				});
				
				//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
				// validate_connection
				//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
				
				$("#validate_connection_button").button();
				$("#validate_connection_button").click(function() {
					$("#validate_connection_result").html('waiting for response...');
					$.ajax({
					  url: '/validate_connection',
					  dataType: 'json',
					  success: function(data, textStatus, jqXHR) {
						  if(data.ok) {
							  $("#validate_connection_result").html('validation OK - ID: ' + data.random_value);
						  } else {
							  $("#validate_connection_result").html('ERROR');
						  }
					  },
					  error: function(jqXHR, textStatus, errorThrown) {
						alert('AJAX ERROR');
					  }
					});
				});
				
				//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
				// Pin XX
				//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
				
				{% for pin in digital_pins %}
				
					// Create buttons
					
					$(".pin{{ pin }}_mode_buttonset").buttonset();
					$(".pin{{ pin }}_output_buttonset").buttonset();
					$(".pin{{ pin }}_input_buttonset").buttonset();
					
				{% endfor %}
				
				//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
				// *** Generic *** setup of components
				//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
				
				// Hide components
				$('.pin_for_read').hide();
				$('.pin_for_write').hide();
				
				// analogWrite() / PWM
				$(".pin_pwm_slider").slider({ value:0, min: 0, max: 255, step: 1});
				
				//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
				// *** Generic *** attach events
				//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
				
				// pinMode(): disable
				$('.pin_mode_dis').change(function() {
					pin = get_pin($(this).attr('id'));
					pin_mode_disable(pin);
				});
				
				// pinMode(): INPUT
				$('.pin_mode_in').change(function() {
					pin = get_pin($(this).attr('id'));
					pin_mode_input(pin);
				});
				
				// pinMode(): OUTPUT
				$('.pin_mode_out').change(function() {
					pin = get_pin($(this).attr('id'));
					pin_mode_output(pin);
				});

				// digitalRead()
				$(".pin_dr_button").click(function() {
					pin = get_pin($(this).attr('id'));
					pin_status_text(pin, 'digitalRead(): HIGH');
				});
				
				// digitalWrite()
				$(".pin_dw_lo").click(function() {
					pin = get_pin($(this).attr('id'));
					pin_digital_write_low(pin);
				});
				
				$(".pin_dw_hi").click(function() {
					pin = get_pin($(this).attr('id'));
					pin_digital_write_high(pin);
				});
				
				// analogWrite()
				$(".pin_pwm_slider").bind("slide", function(event, ui) {
					pin = get_pin($(this).attr('id'));
					pin_status_text(pin, 'PWM: ' + ui.value);
					// TODO: uncheck LOW/HIGH
				});
				
			});
		</script>
	</head>
	<body>
		
	<h1>Py-Arduino-Proxy</h1>
	
	<p style="size: small;">
		<b>digital_pins:</b> {{ digital_pins }}
	</p>
	<p>
		<button id="ping_button">Ping</button> &nbsp; | Result: <span id="ping_result"></span>
	</p>
	<p>
		<button id="validate_connection_button">Validate connection</button> &nbsp; | Result: <span id="validate_connection_result"></span>
	</p>
	
	{% for pin in digital_pins %}
	<div id="pin{{ pin }}" style="padding-bottom: 10px; float: clear;">
		<div>
			
			Pin {{ pin }} - Mode: &nbsp;
			
			<!-- This buttons set the pin mode -->
			<span class="pin{{ pin }}_mode_buttonset">
				<input type="radio" id="pin{{ pin }}_mode_dis" name="pin{{ pin }}_mode" class="pin_mode_dis" checked="checked"/><label for="pin{{ pin }}_mode_dis">Disabled</label>
				<input type="radio" id="pin{{ pin }}_mode_in"  name="pin{{ pin }}_mode" class="pin_mode_in"/><label for="pin{{ pin }}_mode_in">INPUT</label>
				<input type="radio" id="pin{{ pin }}_mode_out" name="pin{{ pin }}_mode" class="pin_mode_out"/><label for="pin{{ pin }}_mode_out">OUTPUT</label>
			</span>
			
			<!-- digitalWrite() -->
			<span class="pin{{ pin }}_output_buttonset pin{{ pin }}_for_write pin_for_write">
				&nbsp; | digitalWrite()&nbsp;
				<input type="radio" id="pin{{ pin }}_dw_lo" name="pin{{ pin }}_dw" class="pin_dw_lo"/><label for="pin{{ pin }}_dw_lo">LOW</label>
				<input type="radio" id="pin{{ pin }}_dw_hi" name="pin{{ pin }}_dw" class="pin_dw_hi"/><label for="pin{{ pin }}_dw_hi">HIGH</label>
			</span>
			
			<!-- digitalRead() -->
			<span class="pin{{ pin }}_input_buttonset pin{{ pin }}_for_read pin_for_read">
				&nbsp; | &nbsp;
				<button id="pin{{ pin }}_dr_button" class="pin_dr_button">digitalRead()</button>
			</span>
			
			&nbsp; | <span id="pin{{ pin }}_status_text" class="pin_status_text">Pin disabled</span>
		</div>
		
		{% if pwm_pins_bitmap_list[pin] %}
		<!-- analogWrite() / PWM -->
		<div class="pin{{ pin }}_for_write pin_for_write pwm_slide">
			<div style="float: left; padding-right: 20px;">analogWrite():</div>
			<div style="width: 400px; float: left;"><div id="pin{{ pin }}_pwm_slider" class="pin_pwm_slider"></div></div>
			<div style="float: clear;"></div>
		</div>
		{% endif %}
		
	</div>
	{% endfor %}
	
	</body>
</html>


